name: CI/CD ML Pipeline

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

env:
  PYTHONUNBUFFERED: "1"

jobs:
  test-and-report:
    runs-on: ubuntu-latest
    permissions:
      contents: write      # needed by CML to post PR comments
      pull-requests: write

    steps:
      # â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout repository
        uses: actions/checkout@v4

      # â”€â”€ 2. Setup CML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup CML
        uses: iterative/setup-cml@v2

      # â”€â”€ 3. Setup uv â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --frozen

      # â”€â”€ 4. Lint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Lint with Ruff
        run: uv run ruff check src/ tests/ dags/

      # â”€â”€ 5. Validate Airflow DAGs (no live Airflow needed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Validate Airflow DAGs
        run: uv run pytest tests/test_dag.py -v --tb=short

      # â”€â”€ 6. DVC â€“ pull prepared data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Configure DVC S3 remote
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          uv run dvc remote modify myremote access_key_id "$AWS_ACCESS_KEY_ID"
          uv run dvc remote modify myremote secret_access_key "$AWS_SECRET_ACCESS_KEY"

      - name: Pull data from DVC remote
        run: uv run dvc pull

      # â”€â”€ 6. Pre-train: data validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run pre-train data validation tests
        run: uv run pytest tests/test_data.py -v --tb=short

      # â”€â”€ 7. Train (DVC pipeline) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run DVC pipeline (prepare + train)
        run: uv run dvc repro

      # â”€â”€ 8. Post-train: artifact + quality gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run post-train tests (Quality Gate)
        run: uv run pytest tests/test_artifacts.py -v --tb=short

      # â”€â”€ 9. Generate CML report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Generate CML report
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          uv run python - <<'EOF'
          import json, pathlib

          metrics_path = pathlib.Path("models/metrics.json")
          metrics = json.loads(metrics_path.read_text())
          train = metrics["train"]
          test  = metrics["test"]

          report = []
          report.append("## ðŸ¤– ML Training Report\n")
          report.append("### ðŸ“Š Metrics\n")
          report.append("| Metric | Train | Test |")
          report.append("|--------|-------|------|")
          report.append(f"| Accuracy  | {train['train_accuracy']:.4f} | {test['test_accuracy']:.4f} |")
          report.append(f"| F1 Score  | {train['train_f1']:.4f}       | {test['test_f1']:.4f}       |")
          report.append(f"| Precision | {train['train_precision']:.4f} | {test['test_precision']:.4f} |")
          report.append(f"| Recall    | {train['train_recall']:.4f}    | {test['test_recall']:.4f}    |")

          f1 = test["test_f1"]
          gate = "âœ… PASSED" if f1 >= 0.80 else "âŒ FAILED"
          report.append(f"\n### ðŸŽ¯ Quality Gate (F1 â‰¥ 0.80): {gate} (F1 = {f1:.4f})\n")

          pathlib.Path("report.md").write_text("\n".join(report))
          EOF

          CM=$(find artifacts -name "confusion_matrix.png" | head -1)
          if [ -n "$CM" ]; then
            echo "" >> report.md
            echo "### ðŸ”¢ Confusion Matrix" >> report.md
            cml publish "$CM" --md >> report.md
          fi

          FI=$(find artifacts -name "feature_importance.png" | head -1)
          if [ -n "$FI" ]; then
            echo "" >> report.md
            echo "### ðŸ“ˆ Feature Importance" >> report.md
            cml publish "$FI" --md >> report.md
          fi

          cml comment create report.md

      # â”€â”€ 10. Upload model artifact (CD â€“ on main push) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload model artifact
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: |
            models/*.joblib
            models/metrics.json
          retention-days: 30
